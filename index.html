<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>GitApp</title>
    <link rel="stylesheet" type="text/css" href="public/styles.css" />
  </head>
  <body>

    <div class="container"></div>

    <script type="text/javascript" src="bower_components/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="bower_components/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/backbone/backbone.js"></script>
    <script type="text/javascript" src="public/backbone.localStorage.js"></script>
    <script type="text/javascript" src="public/react.min.js"></script>
    <script type="text/javascript" src="public/JSXTransformer.js"></script>


    <script type="text/jsx">
    /** @jsx React.DOM */

    var NewUser = React.createClass({
      handleAdd: function() {
        this.props.onAddUser(this.refs.username.getDOMNode().value)
      },
      render: function() {
        return (
          <div className = "new">
            <h2> Add User </h2>
            <input type="text" ref="username"/>
            <button onClick = {this.handleAdd}> Add User</button>
          </div>
        );
      }
    })

    var User = React.createClass({
      render: function() {
        return (
          <div className = "user">
          <a href={ "#users/" + this.props.user.get('username') }> { this.props.user.get('username') } </a>
          </div>
        );
      }
    });

    var Users = React.createClass({

      addUser: function(m) {
        var userCollection = this.props.users,
            id = userCollection.isEmpty() ? 1 : +(_.max(userCollection.pluck('id')) + 1);
        m = m.replace(/\s/g, '');

        userCollection.create({id: id, username: m});
      },
      render: function() {
        this.setState({
          users: this.props.users
        })
        var users = this.props.users.map(function(user) {
          return <User user = {user} />
        });

        return (
          <div className = "users">
            <NewUser onAddUser = { this.addUser }/>
            <h2>Listing Users</h2>
            { users }
          </div>
        );
      },
    });

    </script>
    <script type="text/javascript">
      var app = {
        models: {},
        collections: {},
      };

      app.models.User = Backbone.Model.extend({
        defaults : {
          username :''
        }
      });

      app.collections.Users = Backbone.Collection.extend({
        model: app.models.User,
        localStorage: new Backbone.LocalStorage('github-users')
      });

      app.Router = Backbone.Router.extend({
        routes : {
          "" : "listUsers",
          "users/:name": "showUser"
        }
      });
    </script>

    <script type="text/jsx">
    /** @jsx React.DOM */
      app.start = function() {
        var users = new app.collections.Users(new Backbone.LocalStorage('github-users').findAll()),
            routes = new app.Router();

        routes.on("route:listUsers", function() {
          window.rc = React.renderComponent(
            <Users users={users} />,
            document.querySelector('.container'));
        });

        Backbone.history.start();
      };

      app.start()
    </script>
  </body>
</html>
