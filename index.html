<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>GitApp</title>
    <link rel="stylesheet" type="text/css" href="public/bootstrap.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>

    <div class="container"></div>

    <script type="text/javascript" src="bower_components/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="bower_components/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/backbone/backbone.js"></script>
    <script type="text/javascript" src="public/backbone.localStorage.js"></script>

    <script type="text/javascript" src="bower_components/react/react.js"></script>
    <script type="text/javascript" src="bower_components/react/JSXTransformer.js"></script>
    <script type="text/javascript" src="bower_components/react-bootstrap/react-bootstrap.js"></script>

    <script type="text/jsx">
    /** @jsx React.DOM */

    var Header = React.createClass({
      render: function() {
        return (
          <header className = "navbar navbar-inverse">
            <div className = "container">
              <div className = "navbar-header">
                <a className="navbar-brand"> Gitapp </a>
              </div>
              <ul className = "nav navbar-nav">
                <li> { this.props.content } </li>
              </ul>
            </div>
          </header>
        );
      }
    });

    var NewUser = React.createClass({
      handleAdd: function() {
        this.props.onAddUser(this.refs.username.getDOMNode().value)
      },
      render: function() {
        return (
          <div className = "row">
            <div className = "col-sm-12 form-horizontal">
              <div className = "col-xs-8 col-sm-9">
                <input type="text" ref="username" className="form-control"/>
              </div>
              <div className = "col-xs-4 col-sm-3">
                <button type="button" className="btn btn-primary" onClick = {this.handleAdd}> Add User</button>
              </div>
            </div>
          </div>
        );
      }
    })

    var User = React.createClass({
      render: function() {
        return (
          <li className="list-group-item">
            <a href={ "#users/" + this.props.user.get('username') }> { this.props.user.get('username') } </a>
          </li>
        );
      }
    });

    var Users = React.createClass({
      getInitialState : function() {
        return {
          users: this.props.users
        }
      },
      addUser: function(m) {
        var userCollection = this.props.users,
        id = userCollection.isEmpty() ? 1 : +(_.max(userCollection.pluck('id')) + 1);
        m = m.replace(/\s/g, '');

        userCollection.create({id: id, username: m});
        this.setState({
          users: userCollection
        });
      },
      render: function() {
        var users = this.props.users.map(function(user) {
          return <User user = {user} />
        });

        return (
          <div className = "top-container">
            <Header />
            <div className = "container">
              <NewUser onAddUser = { this.addUser }/>
              <div className = "row">
                <div className = "col-sm-12">
                  <h2>Listing Users</h2>
                </div>
                <div className = "col-sm-12">
                  <ul className = "list-group">
                    { users }
                  </ul>
                </div>
              </div>
            </div>
          </div>
        );
      },
    });

    var Repo = React.createClass({
      render: function() {
        var repo = this.props.repository;
        return (
          <div className = "row">
            <div className = "col-xs-6">
              <a href={repo.html_url}>{repo.name}</a>
            </div>
            <div className = "col-xs-6">
              <a href={"#contributions/" + repo.owner + "/" + repo.name} class="tab">Contributions</a>
            </div>
          </div>
        );
      }
    });

    var Details = React.createClass({
      getInitialState : function() {
        return {
          img_url: '',
          repos: []
        }
      },
      componentDidMount: function() {
        var regex = /(?:page=)(\d+)[^\w]+(?:rel=)"([^"]+)"/g,
            page = this.props.page,
            pages = [];
        $.ajax({
          type: 'GET',
          url: 'https://api.github.com/users/' + this.props.user.username + '/repos',
          data: { page: page || 1 },
          dataType: 'json'
        }).done(function(data, sC, $xhr) {
          if(this.isMounted()) {
            if(link = $xhr.getResponseHeader('Link')) {
              while(m = regex.exec(link)) {
                if(m) pages[m[2]] = m[1];
              }
            }

            this.setState({
              img_url: data[0].owner.avatar_url + "&size=" + Math.ceil(window.innerHeight/2),
              repos: data.map(function(el) { return { html_url: el.html_url, name: el.name, owner: data[0].owner.login } })
            });
          }
        }.bind(this))
      },
      render: function() {
        var repos = this.state.repos.map(function(data) {
          return <Repo repository = {data} />;
        });
        return (
          <div className = "top-container">
            <Header />
            <div className = "container">

              <div classNamme = "col-sm-12 cover">
                <div className = "row">
                  <div className = "col-xs-6">
                    <a href = "#" className =  "thumbnail"> <img src = {this.state.img_url} /> </a>
                  </div>
                  <div className = "col-xs-6">
                    <div className = "page-header">
                      <h4> {this.props.user.username} </h4>
                    </div>
                  </div>
                </div>
              </div>

              <div className = "col-sm-12 navigation">
              </div>

              <div className = "col-sm-12">
                { repos }
              </div>
            </div>
          </div>
        );
      }
    });

    var ContributionGraph = React.createClass({
      render : function() {
        console.log(this.props.stat)
        return (
          <div clasName = "col-xs-12">
            <img src = {this.props.stat.avatar + "&size=20"}/>
            <span> { this.props.stat.total } </span>
            <span> { this.props.stat.username } </span>
          </div>
        );
      }
    });

    var Contributions = React.createClass({
      getInitialState : function() {
        return {
          stats: []
        }
      },

      fetchContributors: function(owner, repo) {
          return $.ajax({
              type: 'GET',
              url: "https://api.github.com/repos/" + owner + "/" + repo + "/stats/contributors",
              dataType: 'json'
          });
      },

      componentDidMount: function() {
        this.fetchContributors(this.props.username, this.props.repository).
            done(function(data, stC, $xhr) {
              var stats = [];
                if($xhr.status == 202) {
                    console.log("retrying..");
                }
                if(!data.length <= 0) {
                  for(var i in data) {
                    stats[i] = { username: data[i].author.login, avatar: data[i].author.avatar_url, total: data[i].total }
                  }
                  this.setState({
                    stats: stats
                  });
                }
              }.bind(this))
            .fail(function() {
              console.log("Failed with indignity!!")
            });
      },

      render: function() {
        var contributions = this.state.stats.map(function(data) {
          return <ContributionGraph stat = {data} />
        });

        return (
          <div className = "top-container">
            <Header />
            <div className = "container">
              <div className = "row">
                { contributions }
              </div>
            </div>
          </div>
        );
      }
    });
    </script>
    <script type="text/javascript">
      var app = {
        models: {},
        collections: {},
      };

      app.models.User = Backbone.Model.extend({
        defaults : {
          username :''
        }
      });

      app.collections.Users = Backbone.Collection.extend({
        model: app.models.User,
        localStorage: new Backbone.LocalStorage('github-users')
      });

      app.Router = Backbone.Router.extend({
        routes : {
          "" : "listUsers",
          "users/:name": "showUser",
          "contributions/:name/:repo": "showContributions"
        }
      });
    </script>

    <script type="text/jsx">
    /** @jsx React.DOM */
      app.start = function() {
        var users = new app.collections.Users(new Backbone.LocalStorage('github-users').findAll()),
            routes = new app.Router();

        routes.on("route:listUsers", function() {
          React.render(
            <Users users={users} />,
            document.body
          );
        });

        routes.on("route:showUser", function(name) {
          var user = users.where({ username: name })[0]
          React.render(
            <Details user = { user.toJSON() } />,
            document.body
          )
        });

        routes.on("route:showContributions", function(name, repo) {
          React.render(
            <Contributions repository = { repo } username = { name } />,
            document.body
          );
        });

        routes.on("route:showUser", function(name) {
          var user = users.where({ username: name })[0]
          React.render(
            <Details user = { user } />,
            document.body
          )
        })

        Backbone.history.start();
      };

      app.start()
    </script>
  </body>
</html>
